<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Plataforma IASD Limache - Gesti√≥n de Culto</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --blue-main: #1e3a8a;
            --gold-accent: #b45309;
            --bg-page: #f8fafc;
            --white: #ffffff;
            --gray-text: #475569;
        }

        * { box-sizing: border-box; }
        body { 
            font-family: 'Montserrat', sans-serif; 
            background-color: var(--bg-page); 
            margin: 0; 
            padding: 10px;
            color: var(--gray-text);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--white);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        header { text-align: center; border-bottom: 2px solid var(--blue-main); padding-bottom: 15px; margin-bottom: 25px; }
        header h1 { color: var(--blue-main); font-family: 'Roboto Slab', serif; margin: 0; font-size: 1.6rem; }
        header p { color: var(--gold-accent); margin: 5px 0; font-weight: bold; letter-spacing: 1px; }

        .section-header {
            background: var(--blue-main);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            margin: 20px 0 15px;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; font-weight: 700; margin-bottom: 5px; color: var(--blue-main); }
        input, select { 
            width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 8px; font-size: 0.9rem; 
        }

        .static-hymn { font-size: 0.85rem; background: #f1f5f9; padding: 10px; border-radius: 8px; border-left: 4px solid var(--gold-accent); margin-bottom: 10px; }

        .actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 30px; }
        button, a { 
            padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; color: white; text-align: center; text-decoration: none;
        }
        .btn-wa { background: #25d366; }
        .btn-pdf { background: var(--blue-main); }
        .btn-clear { background: #ef4444; }

        @media print {
            .actions, input, label, select { display: none !important; }
            body { background: white; padding: 0; }
            .container { box-shadow: none; border: none; width: 100%; max-width: 100%; }
            .print-only { display: block !important; border-bottom: 1px solid #eee; padding: 10px 0; }
            .section-header { background: #eee !important; color: black !important; border: 1px solid #000; }
        }

        .print-only { display: none; font-size: 1rem; }
        @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } .actions { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container" id="contenidoPDF">
    <header>
        <p>IGLESIA ADVENTISTA DEL S√âPTIMO D√çA</p>
        <h1>SAN FRANCISCO DE LIMACHE</h1>
        <small>Planificaci√≥n creada por MGE</small>
    </header>
    

    <div class="grid">
        <div class="form-group">
            <label>S√°bado Fecha:</label>
            <input type="date" id="fecha">
            <div class="print-only" id="p-fecha"></div>
        </div>
        <div class="form-group">
            <label>Predicador(a):</label>
            <input type="text" id="predicador" placeholder="Nombre">
            <div class="print-only" id="p-predicador"></div>
        </div>
    </div>

    <div class="section-header">1. Preludio e Ingreso</div>
    <div class="form-group">
        <label>Cantos Previos (2 a 3 himnos):</label>
        <input type="text" id="previa" placeholder="N¬∞ Himnos">
        <div class="print-only" id="p-previa"></div>
    </div>
    <div class="static-hymn"><strong>Ingreso:</strong> Himno 32 "Nos reunimos en tu santuario" (De pie).</div>
    <div class="static-hymn"><strong>Con Plataforma:</strong> Himno 135 "Cristo nombre sublime".</div>

    <div class="section-header">2. Liturgia Central - Bloque Acompa√±ante 1</div>
    <div class="form-group">
        <label>Nombre Acompa√±ante 1:</label>
        <input type="text" id="acomp1" placeholder="Encargado Bienvenida">
        <div class="print-only" id="p-acomp1"></div>
    </div>
    <div class="static-hymn">‚úÖ Bienvenida y Saludos</div>
    <div class="static-hymn">üìΩÔ∏è Video: "Probad y Ved" (Proyectado)</div>
    <div class="form-group">
        <label>Diezmos y Ofrendas (Himno. 525):</label>
        <input type="text" id="ofrendas_enc" placeholder="Ingresa nombres de Di√°conos">
        <div class="print-only" id="p-ofrendas"></div>
    </div>
    <div class="form-group">
        <label>Himno Inicial (N¬∞ y T√≠tulo):</label>
        <input type="text" id="himno_i" placeholder="Solicitar previamente al predicador">
        <div class="print-only" id="p-himnoi"></div>
    </div>

    <div class="section-header">3. Bloque Acompa√±ante 2</div>
    <div class="form-group">
        <label>Nombre Acompa√±ante 2:</label>
        <input type="text" id="acomp2" placeholder="Encargado Oraci√≥n">
        <div class="print-only" id="p-acomp2"></div>
    </div>
    <div class="form-group">
        <label>Lectura B√≠blica (Cita):</label>
        <input type="text" id="lectura" placeholder="Solicitar previamente al predicador">
        <div class="print-only" id="p-lectura"></div>
    </div>
    <div class="static-hymn">üõê Oraci√≥n Intercesora: <strong>Himno 36</strong> (Fondo Musical)</div>
    
    <div class="form-group">
        <label>Adoraci√≥n Infantil:</label>
        <select id="infantil">
            <option value="Video Proyectado">Video Proyectado</option>
            <option value="Relator(a) presente">Relator(a) presente</option>
        </select>
        <input type="text" id="relatador_nombre" placeholder="Nombre del Relator (si aplica)" style="margin-top:5px;">
        <div class="print-only" id="p-infantil"></div>
    </div>

    <div class="form-group">
        <label>Alabanza Musical (Opcional):</label>
        <input type="text" id="especial" placeholder="Nombre solista/grupo">
        <div class="print-only" id="p-especial"></div>
    </div>

    <div class="section-header">4. Mensaje y Salida</div>
    <div class="static-hymn">üìñ Serm√≥n: <strong>Predicador(a)</strong></div>
    <div class="form-group">
        <label>Himno Final (N¬∞ y T√≠tulo):</label>
        <input type="text" id="himno_f" placeholder="Solicitar previamente al predicador">
        <div class="print-only" id="p-himnof"></div>
    </div>
    <div class="static-hymn">üèÅ Cierre: Oraci√≥n final y Himno 41 (Salida plataforma)</div>
    <div class="static-hymn">üö™ Salida: Himno 57 (Fondo musical)</div>

    <div class="actions">
        <button class="btn-wa" onclick="enviarWhatsApp()">üì≤ Enviar Orden por WhatsApp</button>
        <button class="btn-pdf" onclick="generarPDFyEnviar()">üìÑ Enviar Orden PDF por WhatsApp</button>
        <button type="button" class="btn-clear" onclick="limpiar()">Limpiar</button>
    </div>

    <footer style="margin-top:40px; text-align:center; font-size:0.9rem; color:#1b1068; font-weight: bold;">
        ** Coordinaci√≥n de Plataforma | ANCIANOS | IASD San Francisco de Limache **
    
        <!-- Bot√≥n Volver al Inicio -->
<div style="text-align:center; margin: 30px 0;">
    <a href="index.html" 
        style="display:inline-block; background:#c7a488; color:#1e3a8a; padding:12px 25px; 
        border-radius:10px; font-weight:bold; text-decoration:none; transition:0.3s;"
        onmouseover="this.style.background='#fbbf24'; this.style.color='#000';"
        onmouseout="this.style.background='#b45309'; this.style.color='#1e3a8a';">
        ‚¨Ö Volver al Inicio
    </a>
</div>

</div>
</footer>
<!-- Librer√≠a para PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
// Funci√≥n limpiar con contrase√±a seg√∫n tus instrucciones (iasdsf)
function limpiar() {
    const password = prompt("Ingrese la contrase√±a para limpiar los datos:");
    if (password === "iasdsf") {
        document.querySelectorAll('input').forEach(i => i.value = '');
        document.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
        alert("Datos eliminados correctamente.");
    } else {
        alert("Contrase√±a incorrecta.");
    }
}

// Funci√≥n mejorada para generar PDF y COMPARTIR directamente
async function generarPDFyEnviar() {
    const elemento = document.getElementById("contenidoPDF");
    const fecha = document.getElementById("fecha").value || "Sin_Fecha";
    
    // Preparar opciones m√°s robustas y clonar contenido para evitar recortes
    const opciones = {
        margin: 8, // mm
        filename: `Orden_Culto_${fecha}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: {
            scale: 2,
            useCORS: true,
            letterRendering: true,
            scrollY: 0
        },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['css', 'legacy'] }
    };

    try {
            // Esperar que las fuentes carguen para evitar diferencias al renderizar
            if (document.fonts && document.fonts.ready) await document.fonts.ready;

            // Clonamos el elemento y normalizamos estilos para impresi√≥n PDF
            const clone = elemento.cloneNode(true);
            clone.style.boxShadow = 'none';
            clone.style.borderRadius = '0';
            clone.style.padding = '10mm';
            clone.style.maxWidth = 'none';
            // Convertir mm a px (aprox 96 dpi): px = mm * 96 / 25.4
            const mmToPx = mm => Math.ceil(mm * 96 / 25.4);
            clone.style.width = mmToPx(190) + 'px'; // ancho A4 interior aproximado en px
        // Ajustes CSS adicionales para evitar saltos y recortes
        clone.querySelectorAll('.actions, input, label, select, .btn-clear, .btn-wa, .btn-pdf').forEach(n => n && (n.style.display = 'none'));
        clone.querySelectorAll('.container').forEach(c => { c.style.boxShadow = 'none'; c.style.borderRadius = '0'; });

        // Insertar el clon en posici√≥n absoluta sobre la p√°gina pero casi invisible
        // Quitamos el id para evitar duplicados
        clone.removeAttribute('id');
        clone.style.position = 'absolute';
        clone.style.left = '0';
        clone.style.top = window.scrollY + 'px';
        clone.style.background = '#ffffff';
        clone.style.zIndex = '999999';
        clone.style.opacity = '0.01'; // casi invisible pero renderizable
        clone.style.pointerEvents = 'none';
        document.body.appendChild(clone);

        // Actualizar windowWidth para html2canvas seg√∫n el clon
        // Ajustar escala seg√∫n devicePixelRatio para mejor resoluci√≥n
        opciones.html2canvas.scale = Math.max(2, window.devicePixelRatio || 1);
        // Update windowWidth for html2canvas according to the clone
        opciones.html2canvas.windowWidth = Math.ceil(clone.scrollWidth);

        // Generar el PDF como Blob (archivo en memoria) desde el clon
        const pdfBlob = await html2pdf().set(opciones).from(clone).output('blob');
        const nombreArchivo = `Orden_Culto_${fecha}.pdf`;
        const archivo = new File([pdfBlob], nombreArchivo, { type: 'application/pdf' });

        // Intentar compartir si es posible (m√≥viles modernos)
        if (navigator.canShare && navigator.canShare({ files: [archivo] })) {
            try {
                await navigator.share({
                    files: [archivo],
                    title: 'Orden de Culto',
                    text: 'Adjunto env√≠o el Orden de Culto de la IASD Limache.'
                });
                // Adem√°s de compartir, tambi√©n ofrecemos descarga como respaldo
                const url = URL.createObjectURL(pdfBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = nombreArchivo;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            } catch (shareError) {
                console.warn('Compartir fall√≥, forzando descarga:', shareError);
                const url = URL.createObjectURL(pdfBlob);
                if (window.navigator && window.navigator.msSaveOrOpenBlob) {
                    window.navigator.msSaveOrOpenBlob(pdfBlob, nombreArchivo);
                } else {
                    const newTab = window.open(url, '_blank');
                    if (!newTab) {
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = nombreArchivo;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                    }
                }
                URL.revokeObjectURL(url);
                alert('No fue posible compartir. El PDF se abrir√°/descargar√° para que lo puedas adjuntar manualmente.');
            }
        } else {
            // Si no hay soporte de share con archivos, forzamos la descarga
            const url = URL.createObjectURL(pdfBlob);
            if (window.navigator && window.navigator.msSaveOrOpenBlob) {
                window.navigator.msSaveOrOpenBlob(pdfBlob, nombreArchivo);
            } else {
                const newTab = window.open(url, '_blank');
                if (!newTab) {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = nombreArchivo;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                }
            }
            URL.revokeObjectURL(url);
        // limpiar clon
        document.body.removeChild(clone);
            alert('Tu navegador no permite compartir directamente. El PDF se abrir√°/descargar√° y deber√°s adjuntarlo manualmente en WhatsApp.');
        }
    } catch (error) {
        console.error('Error al generar o compartir:', error);
        alert('Hubo un error al procesar el PDF.');
    }
}

function enviarWhatsApp() {
    const f = id => {
        const el = document.getElementById(id);
        return el && el.value ? el.value : "---";
    };

    const modoInfantil = f("infantil");
    const relator = f("relatador_nombre");
    const infoInfantil = relator !== "---" ? `${modoInfantil} (${relator})` : modoInfantil;

    const mensaje = 
`üìã *ORDEN DE CULTO ‚Äì IASD LIMACHE*

üìÖ Fecha: ${f("fecha")}
üé§ Predicador: ${f("predicador")}

üé∂ *PRELUDIO*
- Himnos previos: ${f("previa")}
- Ingreso: Himno 32
- Plataforma: Himno 135

ü§ù *LITURGIA CENTRAL*
- Acompa√±ante 1: ${f("acomp1")}
- Ofrendas: ${f("ofrendas_enc")}
- Himno Inicial: ${f("himno_i")}

üôè *BLOQUE ESPIRITUAL*
- Acompa√±ante 2: ${f("acomp2")}
- Lectura B√≠blica: ${f("lectura")}
- Oraci√≥n Intercesora: Himno 36
- Adoraci√≥n Infantil: ${infoInfantil}
- Especial: ${f("especial")}

üìñ *MENSAJE*
- Serm√≥n: ${f("predicador")}

üéµ *CIERRE*
- Himno Final: ${f("himno_f")}
- Oraci√≥n Final (Himno 41)
- Salida (Himno 57)

üë¥ ANCIANOS ‚Äì IASD San Francisco de Limache`;

    const ancianos = [
        { nombre: "Mauricio Galaz", numero: "56968401298" },
        { nombre: "Guillermo Vera", numero: "56990724209" },
        { nombre: "Victor Recabarren", numero: "56996997577" }
    ];

    // Para evitar bloqueos de popups, enviamos solo al primero confirmado
    let enviado = false;
    for (let a of ancianos) {
        if (!enviado) {
            const ok = confirm(`¬øEnviar Orden de Culto a ${a.nombre}?`);
            if (ok) {
                const url = `https://wa.me/${a.numero}?text=${encodeURIComponent(mensaje)}`;
                window.open(url, "_blank");
                enviado = true; 
            }
        }
    }
}
</script>


</body>
</html>
