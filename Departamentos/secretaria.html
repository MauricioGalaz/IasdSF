<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secretaría Analítica - IASD Limache</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-slate-950 text-slate-200 font-['Outfit'] pb-24">

    <header class="p-10 text-center bg-gradient-to-b from-[#00305e] to-slate-950 rounded-b-[4rem] shadow-2xl">
            <a href="../index.html" class="flex items-center space-x-2 bg-white/10 px-4 py-2 rounded-full hover:bg-adventist-gold hover:text-adventist-blue transition-all">
                <i class="fas fa-arrow-left"></i>
                <span class="font-bold text-sm">INICIO</span>
            </a>
        <h1 class="text-3xl font-black uppercase tracking-tighter text-white">Análisis Sabático</h1>
        <p class="text-adventist-gold text-[10px] font-bold tracking-[0.3em] uppercase mt-2">Métricas de Membresía y Crecimiento</p>
        
    </header>
    

    <main class="max-w-xl mx-auto p-6 -mt-10 space-y-8">
        
        <section class="bg-slate-900 border border-slate-800 p-8 rounded-[3rem] shadow-2xl">
            <div class="space-y-6">
                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase text-slate-500 ml-2 italic">Fecha del Registro</label>
                    <input type="date" id="fecha" class="w-full bg-slate-800 border-none p-5 rounded-3xl outline-none focus:ring-2 ring-adventist-gold font-bold text-white">
                </div>

                <div class="grid grid-cols-3 gap-3">
                    <div class="text-center">
                        <label class="text-[9px] font-black uppercase text-blue-400">Varones</label>
                        <input type="number" id="varones" placeholder="0" class="w-full bg-slate-800 border-none p-4 rounded-2xl text-center font-bold text-xl">
                    </div>
                    <div class="text-center">
                        <label class="text-[9px] font-black uppercase text-pink-400">Damas</label>
                        <input type="number" id="damas" placeholder="0" class="w-full bg-slate-800 border-none p-4 rounded-2xl text-center font-bold text-xl">
                    </div>
                    <div class="text-center">
                        <label class="text-[9px] font-black uppercase text-green-400">Niños</label>
                        <input type="number" id="ninos" placeholder="0" class="w-full bg-slate-800 border-none p-4 rounded-2xl text-center font-bold text-xl">
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase text-slate-500 ml-2 italic">Visitas Totales</label>
                    <input type="number" id="visitas" placeholder="0" class="w-full bg-slate-800 border-none p-5 rounded-3xl outline-none focus:ring-2 ring-white font-bold text-adventist-gold text-xl">
                </div>

                <button id="btnGuardar" class="w-full bg-white text-[#00305e] py-6 rounded-[2rem] font-black uppercase text-xs tracking-widest hover:bg-adventist-gold transition shadow-xl active:scale-95 flex items-center justify-center gap-3">
                    <i class="fas fa-database"></i> Sincronizar Métricas
                </button>
            </div>
        </section>

        <section class="bg-white rounded-[3rem] p-8 shadow-2xl">
            <h3 class="text-[10px] font-black uppercase text-slate-400 mb-6 tracking-widest border-b pb-2 italic text-center">Evolución de Asistencia y Visitas</h3>
            <canvas id="chartTendencia" height="250"></canvas>
        </section>

        <section class="bg-white rounded-[3rem] p-8 shadow-2xl">
            <h3 class="text-[10px] font-black uppercase text-slate-400 mb-6 tracking-widest border-b pb-2 italic text-center">Composición por Segmentos</h3>
            <canvas id="chartComposicion" height="250"></canvas>
        </section>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIGURACIÓN (Ingresa tus llaves de Firebase)
        const firebaseConfig = {
            apiKey: "AIzaSy...",
            authDomain: "iasd-limache-muro.firebaseapp.com",
            projectId: "iasd-limache-muro",
            storageBucket: "iasd-limache-muro.appspot.com",
            messagingSenderId: "...",
            appId: "..."
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const colRef = collection(db, "asistencia_sabados");

        // BOTÓN GUARDAR
        document.getElementById('btnGuardar').onclick = async () => {
            const v = parseInt(document.getElementById('varones').value) || 0;
            const d = parseInt(document.getElementById('damas').value) || 0;
            const n = parseInt(document.getElementById('ninos').value) || 0;
            
            const payload = {
                fecha: document.getElementById('fecha').value,
                varones: v, damas: d, ninos: n,
                total: v + d + n,
                visitas: parseInt(document.getElementById('visitas').value) || 0,
                timestamp: new Date()
            };

            if(!payload.fecha) return alert("Error: Falta la fecha");

            try {
                await addDoc(colRef, payload);
                alert("Métricas enviadas correctamente a la nube");
                ["varones", "damas", "ninos", "visitas"].forEach(id => document.getElementById(id).value = "");
            } catch (e) { alert("Error de red: " + e); }
        };

        // RENDERIZADO DE GRÁFICOS
        let chartT, chartC;
        onSnapshot(query(colRef, orderBy("fecha", "asc"), limit(8)), (snap) => {
            const labels = [], totales = [], visitas = [], vArr = [], dArr = [], nArr = [];
            
            snap.forEach(doc => {
                const data = doc.data();
                labels.push(data.fecha.slice(5)); // Muestra solo MM-DD
                totales.push(data.total);
                visitas.push(data.visitas);
                vArr.push(data.varones);
                dArr.push(data.damas);
                nArr.push(data.ninos);
            });

            // Actualizar Gráfico 1 (Líneas)
            if(chartT) chartT.destroy();
            chartT = new Chart(document.getElementById('chartTendencia'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Total', data: totales, borderColor: '#00305e', tension: 0.4, fill: true, backgroundColor: '#00305e10' },
                        { label: 'Visitas', data: visitas, borderColor: '#fec325', borderDash: [5, 5] }
                    ]
                }
            });

            // Actualizar Gráfico 2 (Barras Apiladas)
            if(chartC) chartC.destroy();
            chartC = new Chart(document.getElementById('chartComposicion'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Varones', data: vArr, backgroundColor: '#60a5fa' },
                        { label: 'Damas', data: dArr, backgroundColor: '#f472b6' },
                        { label: 'Niños', data: nArr, backgroundColor: '#4ade80' }
                    ]
                },
                options: { scales: { x: { stacked: true }, y: { stacked: true } } }
            });
        });
    </script>

    <footer class="bg-[#0f172a] py-10 border-t border-white/10 text-center">
        <div class="container mx-auto px-6">
            <div class="flex justify-center space-x-6 mb-6">
                <a href="#" class="text-white/40 hover:text-adventist-gold transition"><i class="fab fa-facebook-f fa-lg"></i></a>
                <a href="#" class="text-white/40 hover:text-adventist-gold transition"><i class="fab fa-instagram fa-lg"></i></a>
                <a href="#" class="text-white/40 hover:text-adventist-gold transition"><i class="fab fa-youtube fa-lg"></i></a>
            </div>
            <p class="font-black text-adventist-gold text-xl uppercase tracking-widest italic mb-2">
                IASD SAN FRANCISCO DE LIMACHE
            </p>
            <p class="text-[10px] text-white/30 uppercase tracking-[0.3em] font-bold">
                © 2026 • Diseñado por Mauricio Galaz Estay
            </p>
        </div>
    </footer>
</body>
</html>